name: generate_gfw_iplist

on:
  workflow_dispatch:
  schedule:
    - cron: "0 16 * * *"
  
jobs:
  generatev4:
    runs-on: ubuntu-latest
    steps:
      - name: fetch gfwlist2dnsmasq
        run: wget https://raw.githubusercontent.com/cokebar/gfwlist2dnsmasq/master/gfwlist2dnsmasq.sh
      - name: generate gfw domain list
        run: bash gfwlist2dnsmasq.sh -l -o domainlist.txt
      - name: fetch batchresolv
        run: wget https://raw.githubusercontent.com/hehaorui/utilities/main/scripts/batchresolv.sh
      - name: generate ipv4list 
        run: cat domainlist.txt | bash batchresolv.sh -s 1.1.1.1 -type A -nthr 20 > v4list.txt
      - uses: actions/upload-artifact@v3
        with:
          name: v4list.txt
          path: v4list.txt
          if-no-files-found: error 
          
  generatev6:
    runs-on: ubuntu-latest
    steps:
      - name: fetch gfwlist2dnsmasq
        run: wget https://raw.githubusercontent.com/cokebar/gfwlist2dnsmasq/master/gfwlist2dnsmasq.sh
      - name: generate gfw domain list
        run: bash gfwlist2dnsmasq.sh -l -o domainlist.txt
      - name: fetch batchresolv
        run: wget https://raw.githubusercontent.com/hehaorui/utilities/main/scripts/batchresolv.sh
      - name: generate ipv6list 
        run: cat domainlist.txt | bash batchresolv.sh -s 1.1.1.1 -type AAAA -nthr 20 > v6list.txt
      - uses: actions/upload-artifact@v3
        with:
          name: v6list.txt
          path: v6list.txt
          if-no-files-found: error
  release:
    runs-on: ubuntu-latest
    needs:
      - generatev4
      - generatev6
    steps:
      - uses: actions/download-artifact@v3
        with: 
          name: v4list.txt
      - uses: actions/download-artifact@v3
        with:
          name: v6list.txt
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Get Previous tag
        id: previous_tag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
        with:
          fallback: 0.1
      - uses: softprops/action-gh-release@v1
        with:
          files: |
            v4list.txt
            v6list.txt
          name: ${{ steps.date.outputs.date }}
          tag_name: ${{ steps.previous_tag.outputs.tag }}
